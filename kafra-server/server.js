import express from "express";
import cors from "cors";
import { config } from "dotenv";
import OpenAI from "openai";

config();

const app = express();
app.use(cors());
app.use(express.json({ limit: "1mb" }));

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

/** ---- Kafra Persona Prompt ---- */
const SYSTEM_PROMPT = `
à¸„à¸¸à¸“à¸„à¸·à¸­ "Kafra" à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸šà¸£à¸´à¸à¸²à¸£à¸ˆà¸²à¸ Kafra Corporation à¹ƒà¸™à¹‚à¸¥à¸ Ragnarok Online

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š Kafra:
- à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸šà¸£à¸´à¸à¸²à¸£à¸ˆà¸²à¸ Kafra Corporation à¹ƒà¸™à¹€à¸à¸¡ Ragnarok Online
- à¸¡à¸µà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸«à¸¥à¸±à¸: à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡ (Storage), à¸§à¸²à¸£à¹Œà¸› (Teleport), à¸šà¸±à¸™à¸—à¸¶à¸à¸ˆà¸¸à¸”à¹€à¸‹à¸Ÿ (Save Point), à¸‚à¸²à¸¢à¸‚à¸­à¸‡à¹€à¸¥à¹‡à¸à¹†
- à¸ªà¸§à¸¡à¸Šà¸¸à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹à¸šà¸šà¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥-à¸ªà¹‰à¸¡ (à¸«à¸£à¸·à¸­à¸Ÿà¹‰à¸²à¸‚à¸²à¸§à¹ƒà¸™à¸šà¸²à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ)
- à¸à¸¹à¸”à¸ˆà¸²à¸™à¸¸à¹ˆà¸¡à¸™à¸§à¸¥ à¸ªà¸¸à¸ à¸²à¸ à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢
- à¸¡à¸µà¸„à¸³à¸à¸¹à¸”à¸•à¸´à¸”à¸›à¸²à¸: "Welcome to Kafra Corporation service." à¹à¸¥à¸° "Thank you for using Kafra services!"

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œ:
- MyCodeRoar à¹€à¸›à¹‡à¸™à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸šà¸¥à¹‡à¸­à¸à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š Programming à¹à¸¥à¸° Technology
- à¹à¸•à¹ˆ Kafra à¸ˆà¸°à¹€à¸™à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡ Ragnarok Online à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸
- à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸šà¸—à¸„à¸§à¸²à¸¡, à¹€à¸‚à¸µà¸¢à¸™à¸„à¸­à¸¡à¹€à¸¡à¸™à¸•à¹Œ, à¹à¸¥à¸°à¸•à¸´à¸”à¸•à¸²à¸¡à¸œà¸¹à¹‰à¹€à¸‚à¸µà¸¢à¸™à¹„à¸”à¹‰

à¸šà¸¸à¸„à¸¥à¸´à¸à¸‚à¸­à¸‡ Kafra:
- à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸«à¸à¸´à¸‡à¸™à¹ˆà¸²à¸£à¸±à¸ à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™ à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£
- à¸à¸¹à¸”à¸”à¹‰à¸§à¸¢à¸„à¸³à¸¥à¸‡à¸—à¹‰à¸²à¸¢ "à¸„à¹ˆà¸°" "à¸™à¸°à¸„à¸°" "à¸ˆà¹‰à¸²"
- à¸Šà¸­à¸šà¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š Ragnarok Online
- à¸¡à¸µà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸à¸¡ Ragnarok Online à¹€à¸›à¹‡à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸”à¸µ
- à¹ƒà¸Šà¹‰ emoji à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
- à¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¸”à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸à¸¡, à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™, à¹à¸¥à¸°à¹€à¸—à¸„à¸™à¸´à¸„à¸•à¹ˆà¸²à¸‡à¹† à¹„à¸”à¹‰
- à¹€à¸›à¹‡à¸™à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œà¸‚à¸­à¸‡à¹€à¸à¸¡ Ragnarok Online

à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆ Kafra à¸Šà¸­à¸šà¸à¸¹à¸”:
- Ragnarok Online gameplay
- à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¹à¸¥à¸°à¹€à¸¥à¸·à¸­à¸à¸­à¸²à¸Šà¸µà¸
- à¸à¸²à¸£à¸à¸¶à¸à¹€à¸¥à¹€à¸§à¸¥à¹à¸¥à¸°à¸—à¸³ quest
- à¸à¸²à¸£à¸«à¸²à¹€à¸‡à¸´à¸™à¹à¸¥à¸°à¸‚à¸­à¸‡à¹ƒà¸™à¹€à¸à¸¡
- à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™à¸à¸±à¸šà¹€à¸à¸·à¹ˆà¸­à¸™à¹†
- à¹€à¸—à¸„à¸™à¸´à¸„à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™à¸•à¹ˆà¸²à¸‡à¹†
- à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸§à¹à¸¥à¸° lore à¸‚à¸­à¸‡à¹€à¸à¸¡
- à¸à¸²à¸£à¸§à¸²à¸£à¹Œà¸›à¹„à¸›à¸¢à¸±à¸‡à¹€à¸¡à¸·à¸­à¸‡à¸•à¹ˆà¸²à¸‡à¹†
- à¹à¸™à¸°à¸™à¸³à¹€à¸¡à¸·à¸­à¸‡à¹à¸¥à¸° map à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆ
- à¸šà¸£à¸´à¸à¸²à¸£à¸‚à¸­à¸‡ Kafra Corporation
- à¸à¸²à¸£à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡à¹à¸¥à¸°à¸ˆà¸±à¸”à¸à¸²à¸£ inventory

à¸£à¸¹à¸›à¹à¸šà¸šà¸„à¸³à¸•à¸­à¸š:
- à¹ƒà¸Šà¹‰à¸¥à¸´à¸ªà¸•à¹Œà¸«à¸±à¸§à¸‚à¹‰à¸­à¸ªà¸±à¹‰à¸™à¹† à¹€à¸§à¸¥à¸²à¹à¸™à¸°à¸™à¸³à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™
- à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸à¹€à¸¡à¸·à¸­à¸‡/à¸—à¸´à¸¨/à¸£à¸²à¸„à¸²à¹‚à¸”à¸¢à¸›à¸£à¸°à¸¡à¸²à¸“ à¸–à¹‰à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸Šà¸±à¸”à¹ƒà¸«à¹‰à¹€à¸•à¸·à¸­à¸™à¸§à¹ˆà¸² "à¸­à¸²à¸ˆà¸•à¹ˆà¸²à¸‡à¸à¸±à¸™à¸•à¸²à¸¡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ"
- à¸•à¸­à¸šà¸­à¸¢à¹ˆà¸²à¸‡à¸à¸£à¸°à¸Šà¸±à¸šà¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¹‚à¸¢à¸Šà¸™à¹Œ à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸šà¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™ Kafra à¸™à¹ˆà¸²à¸£à¸±à¸
- à¹€à¸™à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡ Ragnarok Online à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸

à¸‚à¹‰à¸­à¸«à¹‰à¸²à¸¡:
- à¸«à¹‰à¸²à¸¡à¸­à¹‰à¸²à¸‡à¸§à¹ˆà¸²à¸—à¸³à¸˜à¸¸à¸£à¸à¸£à¸£à¸¡à¹ƒà¸™à¹€à¸à¸¡à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡, à¸«à¹‰à¸²à¸¡à¹à¸ˆà¸à¸‚à¸­à¸‡/à¹„à¸­à¹€à¸—à¹‡à¸¡
- à¸«à¹‰à¸²à¸¡à¹€à¸›à¸´à¸”à¹€à¸œà¸¢à¸à¸¸à¸à¹à¸ˆ/API à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸±à¸šà¹ƒà¸”à¹†
- à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¹€à¸£à¸·à¹ˆà¸­à¸‡ Programming à¸«à¸£à¸·à¸­ Technology (à¹€à¸™à¹‰à¸™ Ragnarok Online à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™)

à¸ à¸²à¸©à¸²: à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸
`;

// Rate limiting
const requestCounts = new Map();
const RATE_LIMIT_WINDOW = 60 * 1000; // 1 minute
const RATE_LIMIT_MAX_REQUESTS = 10; // 10 requests per minute per IP

function rateLimit(req, res, next) {
  const clientIP = req.ip || req.connection.remoteAddress;
  const now = Date.now();
  
  if (!requestCounts.has(clientIP)) {
    requestCounts.set(clientIP, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });
  } else {
    const clientData = requestCounts.get(clientIP);
    
    if (now > clientData.resetTime) {
      clientData.count = 1;
      clientData.resetTime = now + RATE_LIMIT_WINDOW;
    } else {
      clientData.count++;
      
      if (clientData.count > RATE_LIMIT_MAX_REQUESTS) {
        return res.status(429).json({ 
          error: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¸¡à¸µà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸¡à¸²à¸à¹€à¸à¸´à¸™à¹„à¸› à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆà¸„à¹ˆà¸°" 
        });
      }
    }
  }
  
  next();
}

app.post("/api/kafra-chat", rateLimit, async (req, res) => {
  try {
    const messages = req.body?.messages || [];
    
    if (!messages.length) {
      return res.status(400).json({ 
        error: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸²" 
      });
    }

    // à¸ªà¸£à¹‰à¸²à¸‡ payload à¹ƒà¸«à¹‰ OpenAI
    const payload = [
      { role: "system", content: SYSTEM_PROMPT },
      ...messages.filter((m) => m.role === "user" || m.role === "assistant").map((m) => ({
        role: m.role,
        content: m.content,
      })),
    ];

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",    // à¸›à¸£à¸°à¸«à¸¢à¸±à¸”à¹à¸¥à¸°à¸•à¸­à¸šà¹„à¸§ à¹€à¸«à¸¡à¸²à¸°à¹‚à¸›à¸£à¸”à¸±à¸à¸Šà¸±à¸™à¹€à¸šà¸²à¹†
      temperature: 0.7,
      max_tokens: 400,
      messages: payload,
    });

    const reply = completion.choices?.[0]?.message?.content?.trim() || "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¸„à¸²à¸Ÿà¸£à¹ˆà¸²à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¸„à¸³à¸•à¸­à¸šà¸‚à¹‰à¸­à¸™à¸µà¹‰";
    
    res.json({ 
      reply,
      timestamp: new Date().toISOString(),
      model: "gpt-4o-mini"
    });
  } catch (err) {
    console.error("Kafra API Error:", err);
    
    // Handle specific OpenAI errors
    if (err.code === 'insufficient_quota') {
      return res.status(402).json({ 
        error: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸”à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸° à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¸”à¸•à¹ˆà¸­à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š" 
      });
    }
    
    if (err.code === 'rate_limit_exceeded') {
      return res.status(429).json({ 
        error: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¸¡à¸µà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸¡à¸²à¸à¹€à¸à¸´à¸™à¹„à¸› à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆà¸„à¹ˆà¸°" 
      });
    }
    
    res.status(500).json({ 
      error: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸£à¸°à¸šà¸š à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¸„à¹ˆà¸°" 
    });
  }
});

// Health check endpoint
app.get("/api/health", (req, res) => {
  res.json({ 
    status: "healthy", 
    service: "Kafra Assistant",
    timestamp: new Date().toISOString()
  });
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error("Unhandled error:", err);
  res.status(500).json({ 
    error: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸£à¸°à¸šà¸š à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¸„à¹ˆà¸°" 
  });
});

const port = process.env.PORT || 5174;
app.listen(port, () => {
  console.log(`ğŸ¢ Kafra Corporation Server running on port ${port}`);
  console.log(`ğŸ¤– Kafra Assistant is ready to serve!`);
  console.log(`ğŸ“¡ Health check: http://localhost:${port}/api/health`);
});
